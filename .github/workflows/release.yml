name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev rpm

      - name: Build binary
        run: |
          make clean || true
          make -j$(nproc) RELEASE_CFLAGS="-O2 -DNDEBUG" RELEASE_CXXFLAGS="-O2 -DNDEBUG -fno-exceptions"
          strip bin/spf
          file bin/spf
          ./bin/spf --help

      - name: Create DEB package (Debian/Ubuntu)
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="1.0.1"
          
          mkdir -p pkg/DEBIAN pkg/usr/local/bin
          cp bin/spf pkg/usr/local/bin/
          chmod 755 pkg/usr/local/bin/spf
          
          cat > pkg/DEBIAN/control << 'CTRL'
          Package: spf
          Version: VERSION_PLACEHOLDER
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libssl3
          Maintainer: SPF Project
          Description: SPF - Simple Port Forwarder and Tunnel (Beta)
           Fast, secure, lightweight TCP proxy with tunnel support.
           A self-hosted alternative to Cloudflare Tunnel and ngrok.
          CTRL
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/" pkg/DEBIAN/control
          
          dpkg-deb --build pkg "spf_${VERSION}_amd64.deb"
          dpkg-deb --info "spf_${VERSION}_amd64.deb"

      - name: Create RPM package (RHEL/Fedora/CentOS)
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="1.0.1"
          
          # RPM doesn't allow hyphens in Version - convert to tilde or dot
          # e.g., 1.2.1-beta becomes 1.2.1~beta (tilde sorts lower than release)
          RPM_VERSION="${VERSION//-/\~}"
          
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp bin/spf rpmbuild/SOURCES/
          
          cat > rpmbuild/SPECS/spf.spec << SPEC
          Name: spf
          Version: $RPM_VERSION
          Release: 1%{?dist}
          Summary: Simple Port Forwarder and Tunnel (Beta)
          License: GPL-2.0
          URL: https://github.com/${{ github.repository }}
          
          %description
          Fast, secure, lightweight TCP proxy with tunnel support.
          A self-hosted alternative to Cloudflare Tunnel and ngrok.
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          install -m 755 %{_sourcedir}/spf %{buildroot}/usr/local/bin/spf
          
          %files
          /usr/local/bin/spf
          SPEC
          
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/spf.spec
          find rpmbuild/RPMS -name "*.rpm" -exec cp {} "./spf-${VERSION}-1.x86_64.rpm" \;

      - name: Prepare release files
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="1.0.1"
          
          mkdir -p release
          cp bin/spf "release/spf-linux-amd64"
          cp *.deb release/
          cp *.rpm release/
          
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt
          ls -la

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "SPF Beta ${{ github.ref_name }}"
          body: |
            ## SPF Beta Release
            
            **Simple Port Forwarder and Tunnel** - A self-hosted alternative to Cloudflare Tunnel and ngrok.
            
            ### Downloads
            - `spf-linux-amd64` - Linux x86_64 binary
            - `spf_*_amd64.deb` - Debian/Ubuntu package
            - `spf-*-1.x86_64.rpm` - RHEL/Fedora/CentOS package
            
            ### Installation
            
            **Binary:**
            ```bash
            chmod +x spf-linux-amd64
            sudo mv spf-linux-amd64 /usr/local/bin/spf
            ```
            
            **Debian/Ubuntu:**
            ```bash
            sudo dpkg -i spf_*_amd64.deb
            ```
            
            **RHEL/Fedora/CentOS:**
            ```bash
            sudo rpm -i spf-*-1.x86_64.rpm
            ```
            
            ### Quick Start
            ```bash
            # Simple port forward
            spf -f 8080:localhost:3000
            
            # Expose local server (like ngrok)
            spf expose 3000 --relay yourserver.com
            ```
            
            See [docs/guide.md](https://github.com/${{ github.repository }}/blob/main/docs/guide.md) for full documentation.
          generate_release_notes: true
          files: release/*
