name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev

      - name: Build
        run: |
          make clean || true
          make -j$(nproc) RELEASE_CFLAGS="-O2 -DNDEBUG" RELEASE_CXXFLAGS="-O2 -DNDEBUG -fno-exceptions"
          strip bin/spf
          file bin/spf
          ./bin/spf --help

      - name: Create DEB package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="2.1.1"
          mkdir -p pkg/DEBIAN pkg/usr/local/bin
          cp bin/spf pkg/usr/local/bin/
          cat > pkg/DEBIAN/control << EOF
          Package: spf
          Version: $VERSION
          Section: net
          Priority: optional
          Architecture: amd64
          Maintainer: ${{ github.repository_owner }}
          Description: SPF - Simple Port Forwarder and Tunnel
           Fast, secure, lightweight TCP proxy with tunnel support.
          EOF
          dpkg-deb --build pkg spf_${VERSION}_amd64.deb

      - name: Create RPM package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          [ -z "$VERSION" ] && VERSION="2.1.1"
          sudo apt-get install -y rpm
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp bin/spf rpmbuild/SOURCES/
          cat > rpmbuild/SPECS/spf.spec << EOF
          Name: spf
          Version: $VERSION
          Release: 1
          Summary: Simple Port Forwarder and Tunnel
          License: GPL-2.0
          
          %description
          Fast, secure, lightweight TCP proxy with tunnel support.
          
          %install
          mkdir -p %{buildroot}/usr/local/bin
          cp %{_sourcedir}/spf %{buildroot}/usr/local/bin/
          
          %files
          /usr/local/bin/spf
          EOF
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -bb rpmbuild/SPECS/spf.spec
          cp rpmbuild/RPMS/x86_64/*.rpm ./spf-${VERSION}-1.x86_64.rpm || cp rpmbuild/RPMS/*/*.rpm ./spf-${VERSION}-1.x86_64.rpm

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            bin/spf
            *.deb
            *.rpm

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-openssl
            make
            pkg-config

      - name: Build
        shell: msys2 {0}
        run: |
          # Build with mingw - override all flags to avoid -march=native
          make clean || true
          make CC=gcc CXX=g++ \
            COMMON_CFLAGS="-Wall -Wextra -O2 -DNDEBUG -DWIN32" \
            COMMON_CXXFLAGS="-Wall -Wextra -O2 -DNDEBUG -std=c++11 -DWIN32" \
            RELEASE_CFLAGS="-O2 -DNDEBUG" \
            RELEASE_CXXFLAGS="-O2 -DNDEBUG -fno-exceptions" \
            RELEASE_LDFLAGS="-s" \
            LIBS="-lssl -lcrypto -lws2_32 -lcrypt32 -lpthread" \
            -j4 || {
              echo "=== Build failed, checking environment ==="
              which gcc
              gcc --version
              pkg-config --libs openssl || true
              exit 1
            }
          
          # Rename to .exe if needed
          if [ -f bin/spf ]; then
            mv bin/spf bin/spf.exe
          fi
          
          ls -la bin/
          file bin/spf.exe || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: bin/spf.exe

  build-macos:
    name: Build macOS
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            arch: x86_64
            openssl_prefix: /usr/local/opt/openssl@3
          - runner: macos-14
            arch: arm64
            openssl_prefix: /opt/homebrew/opt/openssl@3
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install openssl@3 || true
          ls -la ${{ matrix.openssl_prefix }}/lib/ || true

      - name: Build
        run: |
          export LDFLAGS="-L${{ matrix.openssl_prefix }}/lib"
          export CPPFLAGS="-I${{ matrix.openssl_prefix }}/include"
          export PKG_CONFIG_PATH="${{ matrix.openssl_prefix }}/lib/pkgconfig"
          
          make clean || true
          make \
            COMMON_CFLAGS="-Wall -Wextra -O2 -DNDEBUG -I${{ matrix.openssl_prefix }}/include" \
            COMMON_CXXFLAGS="-Wall -Wextra -O2 -DNDEBUG -std=c++11 -I${{ matrix.openssl_prefix }}/include" \
            RELEASE_CFLAGS="-O2 -DNDEBUG" \
            RELEASE_CXXFLAGS="-O2 -DNDEBUG -fno-exceptions" \
            RELEASE_LDFLAGS="-L${{ matrix.openssl_prefix }}/lib" \
            LDFLAGS="-L${{ matrix.openssl_prefix }}/lib" \
            -j$(sysctl -n hw.ncpu)
          
          strip bin/spf || true
          file bin/spf
          ./bin/spf --help || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: bin/spf

  release:
    name: Create Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          VERSION="${GITHUB_REF_NAME#v}"
          
          # Linux
          cp artifacts/linux-builds/spf release/spf-linux-amd64
          cp artifacts/linux-builds/*.deb release/
          cp artifacts/linux-builds/*.rpm release/
          
          # Windows
          cp artifacts/windows-build/spf.exe release/spf-windows-amd64.exe
          
          # macOS
          cp artifacts/macos-x86_64/spf release/spf-macos-x86_64
          cp artifacts/macos-arm64/spf release/spf-macos-arm64
          
          # Checksums
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release/*
